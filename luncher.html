<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Speaq Quiz - Loading...</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      width: 100%;
      overflow: hidden;
    }
    #app-container {
      height: 100%;
      width: 100%;
    }
    iframe {
      display: block;
      width: 100%;
      height: 100%;
      border: none;
    }
  </style>
</head>
<body>
  <div id="app-container">
    <p>Loading application...</p>
  </div>

  <script>
    (function() {
      console.log("LAUNCHER: Page loaded.");
      const container = document.getElementById('app-container');
      const appsScriptUrl = "https://script.google.com/macros/s/AKfycbwRq1lHnNX6vpg3FSh3NJCDCdi6aZoBOaEHj4_K_BkFBl2cxhk9Gbc6OU8v5XTyNz09/exec";
      const googleSiteUrl = "https://sites.google.com/view/speaqquiz";

      // Get referral from URL
      const currentUrlParams = new URLSearchParams(window.location.search);
      const referralCode = currentUrlParams.get("ref");
      console.log(`LAUNCHER: Referral code from URL: '${referralCode}'`);

      // Construct iframe URL
      let finalIframeUrl = appsScriptUrl;
      let params = [];
      if (referralCode) {
         params.push(`ref=${encodeURIComponent(referralCode)}`);
      }
      params.push("host=github");
      if (params.length > 0) {
          finalIframeUrl += `?${params.join('&')}`;
      }
      console.log(`LAUNCHER: Final iframe URL: ${finalIframeUrl}`);

      // Create and insert iframe
      const iframe = document.createElement('iframe');
      iframe.src = finalIframeUrl;

      // Clear loading text and append iframe
      container.innerHTML = '';
      container.appendChild(iframe);
      console.log("LAUNCHER: Iframe embedded.");

      // Optional: Listen for success message
      window.addEventListener('message', function(event) {
        if (!event.origin.startsWith("https://script.google.com") && !event.origin.includes("googleusercontent.com")) {
          console.warn("LAUNCHER: Ignored message from unknown origin:", event.origin);
          return;
        }
        if (event.data?.type === 'signupComplete' && event.data.status === 'success') {
          console.log("LAUNCHER: Signup success. Redirecting in 10s...");
          setTimeout(() => {
            window.location.href = googleSiteUrl;
          }, 10000);
        }
      });
    })();
  </script>
</body>
</html>

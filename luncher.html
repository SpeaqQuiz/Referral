<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Speaq Quiz - Loading...</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    * { box-sizing: border-box; }
    html, body { margin:0; padding:0; height:100%; overflow:hidden; font-family:Arial, sans-serif;}
    #app-container { width:100%; height:100%; }
    iframe { border:0; width:100%; height:100%; display:block; }

    /* --- Modal Styles --- */
    #timeoutModal {
      display: none;
      position: fixed;
      top:0; left:0; right:0; bottom:0;
      background: rgba(0,0,0,0.6);
      z-index: 9999;
      align-items: center;
      justify-content: center;
    }
    #timeoutModal .modal-content {
      background: white;
      border-radius: 12px;
      max-width: 400px;
      width: 90%;
      padding: 24px;
      text-align: center;
      box-shadow: 0 4px 16px rgba(0,0,0,0.2);
    }
    #timeoutModal h2 {
      margin-top: 0;
      font-size: 1.4rem;
      color: #333;
    }
    #timeoutModal p {
      font-size: 1rem;
      color: #555;
      margin: 16px 0;
    }
    #timeoutModal .ref-box {
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: #f7f7f7;
      border-radius: 6px;
      padding: 8px 12px;
      margin-bottom: 16px;
      font-family: monospace;
      font-size: 0.95rem;
    }
    #timeoutModal .ref-box button {
      background: #4CAF50;
      border: none;
      color: white;
      padding: 6px 10px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.9rem;
    }
    #timeoutModal .actions button {
      background: #0066cc;
      border: none;
      color: white;
      padding: 10px 20px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 1rem;
      margin-top: 8px;
    }
    #timeoutModal .actions button:hover {
      background: #005bb5;
    }
  </style>
</head>
<body>
  <div id="app-container">
    <p style="text-align:center; padding-top:50px;">Loading application...</p>
  </div>

  <!-- Timeout Modal -->
  <div id="timeoutModal">
    <div class="modal-content">
      <h2>Signup Timeout</h2>
      <p>
        We couldn’t confirm your signup in time.<br>
        Please go to our main page and sign up there.
      </p>
      <div class="ref-box">
        <span id="referralCodeDisplay"></span>
        <button id="copyReferralBtn">Copy</button>
      </div>
      <div class="actions">
        <button id="goMainBtn">Go to SpeaqQuiz</button>
      </div>
    </div>
  </div>

  <script>
  (function() {
    const container       = document.getElementById('app-container');
    const appsScriptUrl   = "https://script.google.com/macros/s/AKfycbwRq1lHnNX6vpg3FSh3NJCDCdi6aZoBOaEHj4_K_BkFBl2cxhk9Gbc6OU8v5XTyNz09/exec";
    const statusCheckerUrl= "https://script.google.com/macros/s/AKfycbylrN0x0nXGbBLU4vH0t3YRwnKC3kO0cQ2z2GUSb1k5N-V4bv3TbKOAPcslPAdY3gRr/exec";
    const googleSiteUrl   = "https://sites.google.com/view/speaqquiz";

    let pollingIntervalId = null;
    let pollingAttempts   = 0;
    const maxPollingAttempts    = 10;    // 5 minutes total
    const pollingIntervalMillis = 5000;  // every 5s
    const redirectDelayMillis   = 10000; // 10s after success

    const sessionId     = Date.now().toString(36) + Math.random().toString(36).substring(2);
    const referralCode  = new URLSearchParams(window.location.search).get("ref");

    // Insert iframe
    let finalIframeUrl = appsScriptUrl + '?sessionId=' + encodeURIComponent(sessionId);
    if (referralCode) finalIframeUrl += '&ref=' + encodeURIComponent(referralCode);
    container.innerHTML = `<iframe src="${finalIframeUrl}"></iframe>`;

    // Modal elements
    const modal        = document.getElementById('timeoutModal');
    const refDisplay   = document.getElementById('referralCodeDisplay');
    const copyBtn      = document.getElementById('copyReferralBtn');
    const goMainBtn    = document.getElementById('goMainBtn');

    refDisplay.textContent = referralCode || '—';
    copyBtn.addEventListener('click', () => {
      navigator.clipboard.writeText(referralCode || '')
        .then(() => copyBtn.textContent = 'Copied!')
        .catch(() => copyBtn.textContent = 'Failed');
    });
    goMainBtn.addEventListener('click', () => {
      window.location.href = googleSiteUrl;
    });

    // Polling
function poll() {
  pollingAttempts++;
  console.log(`LAUNCHER: Poll #${pollingAttempts} for session ${sessionId}`);
  if (pollingAttempts > maxPollingAttempts) {
    console.warn(`LAUNCHER: Timeout after ${maxPollingAttempts} polls.`);
    clearInterval(pollingIntervalId);
    modal.style.display = 'flex';
    return;
  }
  fetch(`${statusCheckerUrl}?sessionId=${encodeURIComponent(sessionId)}`)
    .then(r => {
      console.log(`LAUNCHER: HTTP ${r.status}`);
      return r.json();
    })
    .then(data => {
      console.log("LAUNCHER: Status response:", data);
      if (data.status === 'success') {
        console.log("LAUNCHER: Success—redirecting soon");
        clearInterval(pollingIntervalId);
        setTimeout(() => window.location.href = googleSiteUrl, redirectDelayMillis);
      }
    })
    .catch(err => console.error("LAUNCHER: Poll error:", err));
}


    // start
    setTimeout(() => {
      pollingIntervalId = setInterval(poll, pollingIntervalMillis);
      poll();
    }, pollingIntervalMillis);

  })();
  </script>
</body>
</html>

<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Speaq Quiz - Loading...</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        /* Ensure padding/borders are included in width/height */
        * { box-sizing: border-box; }
        html, body { margin: 0; padding: 0; height: 100%; overflow: hidden; }
        #app-container { width: 100%; height: 100%; }
        iframe { border: none; width: 100%; height: 100%; display: block; }
    </style>
</head>
<body>
    <div id="app-container">
        <p style="text-align: center; padding-top: 50px;">Loading application...</p>
    </div>

    <script>
    (function() {
        console.log("LAUNCHER: Page loaded.");
        const container = document.getElementById('app-container');

        // --- URLs ---
        const appsScriptUrl     = "https://script.google.com/macros/s/AKfycbwRq1lHnNX6vpg3FSh3NJCDCdi6aZoBOaEHj4_K_BkFBl2cxhk9Gbc6OU8v5XTyNz09/exec";
        const statusCheckerUrl  = "https://script.google.com/macros/s/AKfycbylrN0x0nXGbBLU4vH0t3YRwnKC3kO0cQ2z2GUSb1k5N-V4bv3TbKOAPcslPAdY3gRr/exec";
        const googleSiteUrl     = "https://sites.google.com/view/speaqquiz";
        // --- End URLs ---

        // --- Polling Configuration ---
        let pollingIntervalId = null;
        let pollingAttempts   = 0;
        const maxPollingAttempts    = 10;    // 60 × 5 s = 5 minutes
        const pollingIntervalMillis = 5000;  // 5 s
        const redirectDelayMillis   = 10000; // 10 s after success
        // --- End Polling Configuration ---

        if (!container) {
            console.error("LAUNCHER: Container div not found!");
            return;
        }

        // --- Generate Session ID & get referral code ---
        const sessionId    = Date.now().toString(36) + Math.random().toString(36).substring(2);
        const currentUrlParams = new URLSearchParams(window.location.search);
        const referralCode = currentUrlParams.get("ref");
        console.log(`LAUNCHER: Referral code: '${referralCode}', Session ID: ${sessionId}`);

        // --- Build iframe URL ---
        let finalIframeUrl = appsScriptUrl;
        const params = [];
        if (referralCode) params.push(`ref=${encodeURIComponent(referralCode)}`);
        params.push(`sessionId=${encodeURIComponent(sessionId)}`);
        finalIframeUrl += `?${params.join('&')}`;
        console.log("LAUNCHER: Iframe URL:", finalIframeUrl);

        // --- Embed iframe ---
        const iframe = document.createElement('iframe');
        iframe.src    = finalIframeUrl;
        container.innerHTML = '';
        container.appendChild(iframe);

        // --- Polling Function ---
        function pollForSignupStatus() {
            pollingAttempts++;
            if (pollingAttempts > maxPollingAttempts) {
                console.warn(`LAUNCHER: Timeout after ${maxPollingAttempts} polls.`);
                clearInterval(pollingIntervalId);

                // TIMEOUT: alert and redirect
                alert(
                  "We couldn’t confirm your signup in time.\n\n" +
                  "You’ll be redirected to the SpeaqQuiz main page.\n\n" +
                  "If you haven’t signed up yet, please do so there using your referral email:\n" +
                  referralCode
                );
                window.location.href = googleSiteUrl;
                return;
            }

            console.log(`LAUNCHER: Poll #${pollingAttempts} for session ${sessionId}`);
            const checkUrl = `${statusCheckerUrl}?sessionId=${encodeURIComponent(sessionId)}`;

            fetch(checkUrl)
              .then(res => {
                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                return res.json();
              })
              .then(data => {
                console.log("LAUNCHER: Status response:", data);
                if (data.status === 'success') {
                  clearInterval(pollingIntervalId);
                  console.log(`LAUNCHER: Success! Redirecting in ${redirectDelayMillis/1000}s.`);
                  setTimeout(() => {
                    window.location.href = googleSiteUrl;
                  }, redirectDelayMillis);
                } else {
                  console.log("LAUNCHER: Still pending…");
                }
              })
              .catch(err => {
                console.error("LAUNCHER: Polling error:", err);
              });
        }

        // --- Start Polling after initial delay ---
        const initialPollingDelay = 5000; // 5 s
        console.log(`LAUNCHER: Will start polling in ${initialPollingDelay/1000}s`);
        setTimeout(() => {
          pollingIntervalId = setInterval(pollForSignupStatus, pollingIntervalMillis);
          pollForSignupStatus();
        }, initialPollingDelay);

    })();
    </script>
</body>
</html>
